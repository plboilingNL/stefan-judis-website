<!DOCTYPE html>
<html {{ HTML_ATTRS }}>
  <head>
    {{ HEAD }}
    <script>
      (function() {
        if (window.PerformanceObserver) {
          const entryHandlers = {
            longtask: function(entry) {
              console.log(
                '%c LONG TASK TRACKING %c ->',
                'background: green; color: white; display: block;',
                '',
                entry
              )
            }
          };

          (new PerformanceObserver(list => {
            list
              .getEntries()
              .forEach(entry => {
                if (entryHandlers[entry.entryType]) {
                  entryHandlers[entry.entryType](entry)
                }
              })
          })).observe({
            entryTypes: ['longtask']
          })
        }
      })()
    </script>
  </head>
  <body {{ BODY_ATTRS }}>
    {{ APP }}

    <script>
      // todo unify this with the client side javascript
      (function() {
        const checkWebpSupport = () => {
          return new Promise((resolve) => {
            // taken from https://github.com/Modernizr/Modernizr/blob/master/feature-detects/img/webp.js
            const image = new Image()
            const uri = 'data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoBAAEAAwA0JaQAA3AA/vuUAAA='

            function addResult (event) {
              const result = event && event.type === 'load' ? image.width === 1 : false
              resolve(result)
            }

            image.onerror = addResult
            image.onload = addResult

            image.src = uri
          })
        }


        checkWebpSupport().then(supportsWebp => {
          Array.prototype.slice.call(document.querySelectorAll('.c-lazyImage')).forEach(image => {
            const neededImageWidth = Math.floor(
              image.getBoundingClientRect().width * window.devicePixelRatio
            )

            // something fucks up nuxt with template literals here
            const imageSrc = image.dataset.url +
              '?w=' + neededImageWidth +
              '&h=' + Math.round(neededImageWidth * +image.dataset.ratio) +
              '&fit=fill' +
              (supportsWebp ? '&fm=webp' : '')

            if (window.IntersectionObserver) {
              const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                  if (entry.intersectionRatio > 0) {
                    const imageToLoad = document.createElement('img')
                    imageToLoad.alt = image.dataset.alt

                    imageToLoad.onload = () => {
                      image.appendChild(imageToLoad)
                    }

                    imageToLoad.src = imageSrc
                    observer.unobserve(image)
                  }
                })
              }, {threshold: 0})

              observer.observe(image)
            }
          })
        })
      })()
    </script>
  </body>
</html>
